<!DOCTYPE html>
<meta charset="utf-8">
<style> /* set the CSS */
body { font: 12px Arial;}
</style>
<body>

<!-- load the plotly.js and math.js libraries -->      

<head>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://unpkg.com/mathjs@6.6.1/dist/math.min.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>


<body>

  <!-- load the plotly.js library -->      
<div id="graph" width="500" height="100"></div>


<script>



function makeplot() {
  Plotly.d3.csv("data_fit.csv", function(data){ processData(data) } );
};


// fit y = b1 + b2 x  with least squares

function fitLS(x_vec,y_vec,){
  const range_val = [...Array(x_vec.length).keys()];
  var x_mat = math.ones(x_vec.length,2)
  x_mat = math.subset(x_mat,math.index(range_val, 0), x_vec);
  var pinv_mat = math.multiply(math.transpose(x_mat),x_mat);
  var id_mat = math.identity(math.size(pinv_mat));
  id_mat = math.multiply(id_mat,0.05);
  pinv_mat = math.add(pinv_mat,id_mat);
  pinv_mat = math.inv(pinv_mat);
  pinv_mat = math.multiply(pinv_mat, math.transpose(x_mat))
  return math.multiply(pinv_mat,y_vec);
}


// count_vec is vector of true counts
// test range is range on which to test data,
// out_range is range on which to output data
function buildModels(test_range, out_range, count_vec){
  //fit linear and exponential models 
  var range_val = [...Array(count_vec.length).keys()];
  var x_vec = math.add(range_val,1);

  x_vec = x_vec.slice(0,test_range+1);
  y_vec = count_vec.slice(0,test_range+1);
  y_vec = math.matrix(y_vec)


  // fit  y = b1 + b2 x 
  const beta_hat_linear = fitLS(x_vec,y_vec);
  const b1 = beta_hat_linear.subset(math.index(1));
  const b2 = beta_hat_linear.subset(math.index(0));


  // fit y = a1 *exp(a2 x)
  const beta_hat_exp = fitLS(x_vec, math.log(y_vec))
  const a1 = math.exp(beta_hat_exp.subset(math.index(1)));
  const a2 = beta_hat_exp.subset(math.index(0));


  //fill the prediction vectors 
  x_vec = [...Array(out_range+1).keys()];
  x_vec = math.add(x_vec,1)

  var linear_fit = [];
  var exp_fit = [];
  for (var i=0; i<x_vec.length; i++) {
    linear_fit.push(b1 + b2*x_vec[i])
    exp_fit.push(a1*math.exp(a2*x_vec[i]))
  }


  return [b1,b2,a1,a2,linear_fit,exp_fit];


}

  
function processData(allRows) {
  var dates = [];
  var total_count = [];
  for (var i=0; i<allRows.length; i++) {
    row = allRows[i];
    dates.push( row['date'] );
    total_count.push( row['total_count'] );
  }

  makePlotly( dates,total_count);
}





function makePlotly( dates, total_count){
  var plotDiv = document.getElementById("plot");

  // each frame is going to correspond to a day and the model
  // fit up to that point 
  var frames = [];
  //console.log(dates.slice(0,dates.length))

  for (var i = 0; i < dates.length; i++) {
    frames[i] = {data: [{x: [], y: []}, {x: [], y: [], name: []}, {x: [], y: [], name: []}], name: dates[i]};
    frames[i].data[0].x = dates.slice(0, i+1);
    frames[i].data[0].y = total_count.slice(0, i+1);

    //console.log(dates.slice(0,i+1))
    if(i == 0){
      frames[i].data[2].x = dates.slice(0, i+1);
      frames[i].data[2].y = total_count.slice(0, i+1);
      frames[i].data[2].name = "Linear Fit"


      frames[i].data[1].x = dates.slice(0, i+1);
      frames[i].data[1].y = total_count.slice(0, i+1);
      frames[i].data[1].name = "Exponential Fit"


    } else {
      // fit the linear and exponential models on this slice
      count_vec = math.clone(total_count);
     // const curr_day = 27;
      var test_range = i;
    //  var test_range = math.min(i+1,curr_day+1);
      var out_range = i;

      out_vec = buildModels(test_range, out_range,count_vec);
      b1 = out_vec[0];
      b2 = out_vec[1];
      a1 = out_vec[2];
      a2 = out_vec[3];
      linear_fit = out_vec[4];
      exp_fit = out_vec[5];
     // console.log(a2);


      frames[i].data[2].x = dates.slice(0, i+1);
      frames[i].data[2].y = linear_fit;

      frames[i].data[2].name = math.round(String(b1),1) + " + " + math.round(String(b2),3) + "(day)"
      frames[i].data[1].name = math.round(String(a1),1) + " e^(" + math.round(String(a2),4) + "(day))"



      frames[i].data[1].x = dates.slice(0, i+1);
      frames[i].data[1].y = exp_fit;
    }

  }

  var sliderSteps = [];
  for (i = 0; i < dates.length; i++) {
    sliderSteps.push({
      method: 'animate',
      label: i+1,
      args: [[dates[i]], {
        mode: 'immediate',
        transition: {duration: 300},
        frame: {duration: 300, redraw: true},
      }]
    });
  }


  const start_ind = dates.length-1;

  var trace1 = {
      x: frames[start_ind].data[0].x, 
      y: frames[start_ind].data[0].y,
      mode: 'markers',
      type: 'scatter',
      name: 'Total Confirmed Cases',
  };


  var trace2 = {
      x: frames[start_ind].data[1].x, 
      y: frames[start_ind].data[1].y,
      mode: 'lines',
      type: 'scatter',
      name: frames[start_ind].data[1].name
  };

   var trace3 = {
      x: frames[start_ind].data[2].x, 
      y: frames[start_ind].data[2].y,
      mode: 'lines',
      type: 'scatter',
      name: frames[start_ind].data[2].name
  };
  

  var data = [trace1,trace2,trace3];

  // create the traces 
 // console.log(frames[dates.length-1].data[1].x[dates.length-1])



  var layout = {
    title: {
      text:'COVID-19 in Kuwait',
      font: {
        family: 'Courier New, monospace',
        size: 24
      },
      xref: 'paper',
    },
    xaxis: {
      type: 'date',
      range: ["2020-02-23", "2020-04-06"],
      //range: ["2020-02-23", frames[dates.length-1].data[1].x[dates.length-1]],
      //range: ["2020-02-23", frames[dates.length-1].data[1].x],
      showgrid: false
    },
    yaxis: {
      //range: [0, frames[dates.length-1].data[1].y[dates.length]+10],
      range: [0, 500],
      //range: [0, frames[dates.length-1].data[1].y],
      showgrid: false
    },
    legend: {
      //orientation: 'd',
      y: 0.5,
      yref: 'paper',
      font: {
        family: 'Courier New, monospace',
        size: 15
      },
    bgcolor: '#E2E2E2',
    bordercolor: '#FFFFFF',
    borderwidth: 2
    },
    colorway : ['#000000', '#ff0000', '#0000ff'],


     hovermode: 'closest',
   // We'll use updatemenus (whose functionality includes menus as
   // well as buttons) to create a play button and a pause button.
   // The play button works by passing `null`, which indicates that
   // Plotly should animate all frames. The pause button works by
   // passing `[null]`, which indicates we'd like to interrupt any
   // currently running animations with a new list of frames. Here
   // The new list of frames is empty, so it halts the animation.
    updatemenus: [{
      x: 0,
      y: 0,
      yanchor: 'top',
      xanchor: 'left',
      showactive: false,
      direction: 'left',
      type: 'buttons',
      pad: {t: 87, r: 10},
      buttons: [{
        method: 'animate',
        args: [null, {
          mode: 'immediate',
          fromcurrent: true,
          transition: {duration: 300},
          frame: {duration: 500, redraw: true}
        }],
        label: 'Play'
      }, {
        method: 'animate',
        args: [[null], {
          mode: 'immediate',
          transition: {duration: 0},
          frame: {duration: 0, redraw: true}
        }],
        label: 'Pause'
      }]
    }],

    // Finally, add the slider and use `pad` to position it
   // nicely next to the buttons.
    sliders: [{
      pad: {l: 130, t: 55},
      currentvalue: {
        visible: true,
        prefix: 'Days since first confirmed case:',
        xanchor: 'right',
        font: {size: 20, color: '#666'}
      },
      steps: sliderSteps
    }]
  



  
  };


  // Create the plot:
  Plotly.newPlot('graph', {
    data: data,
    layout: layout,
    frames: frames,
    responsive: true, 
  });

 // Plotly.newPlot('graph', data, layout, {responsive:true}).then(function() {
 //   Plotly.addFrames('graph', frames);
 // });



 // Plotly.newPlot('graph', data, layout, {responsive:true});


};


  makeplot();
</script>


</body>

<hr>
  

Each data point corresponds to daily, public updates by Kuwait's <a href = "https://twitter.com/KUWAIT_MOH"> Ministry of Health</a>
or <a href = "https://twitter.com/MOInformation" > Ministry of Information</a> of the total number of confirmed COVID-19 cases in Kuwait.
<br>
<br>
The <font color = "blue" > blue </font> line represents a best linear fit up to that day: count = b_1 + b_2 (day). 
<br> 
The <font color = "red" > red </font> line represents a best exponential fit: count = a_1 e^(a_2 (day)).
<br>
<br> 
Both models are fit with <a href = "http://web.stanford.edu/class/ee103/lectures/regression_slides.pdf"> regression</a>. 
<br> 
<br>


Click the buttons and slider bar to see the best linear and exponential models for that day. See the legend on the right for the fit parameters. 

<br>

Notice the parameters of the exponential model do not change much day 16-27,  while the slope of the linear model keeps growing. This suggested we have not reached an <a href = "https://youtu.be/Kas0tIxDvrg"> inflection point </a> for the curve. The large number of cases in the last week also suggests this. 


<br></br>
In the last two days there were <font color = "red" > 137 new cases</font>, the largest two day increase in Kuwait since the beginning of the pandemic. 
<br></br>
The current doubling time in Kuwait is <font color = "red"> 6 days </font>. 

<hr>
      Last updated April 04, 7:00 AM CDT.  
<hr>


   <footer>
      Created and maintained by <a href = "https://home.uchicago.edu/~ahmedb/"> Ahmed Bou-Rabee.</a> Please email feedback and suggestions 
      <a href = "mailto: ahmedmb@gmail.com">here</a>. 
    </footer>




