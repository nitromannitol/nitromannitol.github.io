<!DOCTYPE html>
<meta charset="utf-8">
<style> /* set the CSS */
body { 
  font: 12px Arial; 
}
</style>
<body>

<!-- load the plotly.js and math.js libraries -->      

<head>
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script src="https://unpkg.com/mathjs@6.6.1/dist/math.min.js"></script>
<script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>

</head>



<body>


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/css/bootstrap-multiselect.css">
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
<script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-multiselect/0.9.13/js/bootstrap-multiselect.js"></script>


<div class="plot" id="plotdiv">

</div>

<div> 
<form id="form1">
   <select class="countrydata" id = "countrydata_" multiple="multiple">
    <option value="Afghanistan">Afghanistan</option>
<option value="Algeria">Algeria</option>
<option value="Argentina">Argentina</option>
<option value="Australia">Australia</option>
<option value="Austria">Austria</option>
<option value="Azerbaijan">Azerbaijan</option>
<option value="Bahrain">Bahrain</option>
<option value="Belarus">Belarus</option>
<option value="Belgium">Belgium</option>
<option value="Brazil">Brazil</option>
<option value="Cambodia">Cambodia</option>
<option value="Canada">Canada</option>
<option value="Chile">Chile</option>
<option value="China">China</option>
<option value="Croatia">Croatia</option>
<option value="Czech Republic">Czech Republic</option>
<option value="Denmark">Denmark</option>
<option value="Ecuador">Ecuador</option>
<option value="Egypt">Egypt</option>
<option value="Estonia">Estonia</option>
<option value="Finland">Finland</option>
<option value="France">France</option>
<option value="Georgia">Georgia</option>
<option value="Germany">Germany</option>
<option value="Greece">Greece</option>
<option value="Hungary">Hungary</option>
<option value="Iceland">Iceland</option>
<option value="India">India</option>
<option value="Iran">Iran</option>
<option value="Iraq">Iraq</option>
<option value="Ireland">Ireland</option>
<option value="Israel">Israel</option>
<option value="Italy">Italy</option>
<option value="Japan">Japan</option>
<option value="Kuwait">Kuwait</option>
<option value="Latvia">Latvia</option>
<option value="Lebanon">Lebanon</option>
<option value="Macedonia">Macedonia</option>
<option value="Malaysia">Malaysia</option>
<option value="Nepal">Nepal</option>
<option value="Netherlands">Netherlands</option>
<option value="Norway">Norway</option>
<option value="Oman">Oman</option>
<option value="Pakistan">Pakistan</option>
<option value="Philippines">Philippines</option>
<option value="Poland">Poland</option>
<option value="Portugal">Portugal</option>
<option value="Qatar">Qatar</option>
<option value="Romania">Romania</option>
<option value="Russia">Russia</option>
<option value="San Marino">San Marino</option>
<option value="Saudi Arabia">Saudi Arabia</option>
<option value="Singapore">Singapore</option>
<option value="Slovenia">Slovenia</option>
<option value="South Korea">South Korea</option>
<option value="Spain">Spain</option>
<option value="Sri Lanka">Sri Lanka</option>
<option value="Sweden">Sweden</option>
<option value="Switzerland">Switzerland</option>
<option value="Taiwan">Taiwan</option>
<option value="Thailand">Thailand</option>
<option value="United Arab Emirates">United Arab Emirates</option>
<option value="United Kingdom">United Kingdom</option>
<option value="United States">United States</option>
<option value="Vietnam">Vietnam</option>
<option value="World">World</option>
    </select>
    <input type="button" id="btnget" value="Plot Selected Countries" />
</form>
</div>





<script>

$(function() {
      $('#countrydata_').multiselect({
        includeSelectAllOption: true,
        enableCaseInsensitiveFiltering: true,
      });

      $('#btnget').click(function(){

        console.log($('#countrydata_').val())
       // alert($('#countrydata_').val());
        makeplot($('#countrydata_').val())
      });
  });



function unique ( array ) {
    return array.filter(function(a){
        return !this[a] ? this[a] = true : false;
    }, {});
}


function makeplot(countries = ["Kuwait"]) {
  Plotly.d3.csv("total_cases_per_million.csv", function(data){ processData(data, countries) } );
};





// fit y = b1 + b2 x  with least squares
function fitLS(x_vec,y_vec,){
  const range_val = [...Array(x_vec.length).keys()];
  var x_mat = math.ones(x_vec.length,2)
  x_mat = math.subset(x_mat,math.index(range_val, 0), x_vec);
  var pinv_mat = math.multiply(math.transpose(x_mat),x_mat);
  pinv_mat = math.inv(pinv_mat);
  pinv_mat = math.multiply(pinv_mat, math.transpose(x_mat))
  return math.multiply(pinv_mat,y_vec);
}


// count_vec is vector of true counts
// test range is range on which to test data,
// out_range is range on which to output data
function buildModels(test_range, out_range, count_vec){
  //fit linear and exponential models 
  var range_val = [...Array(count_vec.length).keys()];
  var x_vec = math.add(range_val,1);

  x_vec = x_vec.slice(0,test_range+1);
  y_vec = count_vec.slice(0,test_range+1);
  y_vec = math.matrix(y_vec)


  // fit  y = b1 + b2 x 
 // console.log(x_vec, y_vec)
  const beta_hat_linear = fitLS(x_vec,y_vec);
  const b1 = beta_hat_linear.subset(math.index(1));
  const b2 = beta_hat_linear.subset(math.index(0));


  // fit y = a1 *exp(a2 x)
  const beta_hat_exp = fitLS(x_vec, math.log(y_vec))
  const a1 = math.exp(beta_hat_exp.subset(math.index(1)));
  const a2 = beta_hat_exp.subset(math.index(0));


  //fill the prediction vectors 
  x_vec = [...Array(out_range+1).keys()];
  x_vec = math.add(x_vec,1)

  var linear_fit = [];
  var exp_fit = [];
  for (var i=0; i<x_vec.length; i++) {
    linear_fit.push(b1 + b2*x_vec[i])
    exp_fit.push(a1*math.exp(a2*x_vec[i]))
  }


  return [b1,b2,a1,a2,linear_fit,exp_fit];


}

  
function processData(allRows, countries) {
  var dates = [];
  var total_count = [];
  var locations = []; 
  for (var i=0; i<allRows.length; i++) {
    row = allRows[i];
    dates.push( row['Date'] );
    total_count.push( row['Total confirmed cases per million (cases per million)'] );
    locations.push(row['Entity']);
  }
  makePlotly( dates,total_count, locations, countries);
}



function makePlotly( dates, norm_count, locations, countries){
  var plotDiv = document.getElementById("plotdiv");




  // each frame will be associated to a country
  // exponential model fit  
  // total cases per million up to that point in time 
  var frames = [];
  unique_locations = unique(locations);
  for(var i = 0; i < unique_locations.length; i++){
    //fill out the array corresponding to the normalized count of country
    //starting at first day
    var y = []; 
    //y.push(0);
    for(var j = 0; j < dates.length; j++){
      if(locations[j] == unique_locations[i] && norm_count[j] > 0){
        y.push(norm_count[j]);
      }
    };
    if(y.length < 20){
      continue; 
    }

    //this doesn't work at the moment so need to do by hand 
    // selector = document.querySelector('.countrydata');
    // textArray = unique_locations[i]; 
    // var currentOption = document.createElement('option');
    // currentOption.text = textArray;
    // currentOption.value = textArray;
    // selector.appendChild(currentOption);

    var x =[...Array(y.length).keys()];
    x = math.add(x,1)
    var curr_frame =  {data: [{x: [], y: []}, {x: [], y: [], name: []}, {x: [], y: [], name: []}], name: unique_locations[i]};

    curr_frame.data[0].x = x;
    curr_frame.data[0].y = y; 


    // fit the linear and exponential models for this country
      count_vec = math.clone(y);
      var test_range = y.length;
      var out_range = y.length;

      //console.log(test_range, out_range, count_vec)

      out_vec = buildModels(test_range, out_range,count_vec);

      b1 = out_vec[0];
      b2 = out_vec[1];
      a1 = out_vec[2];
      a2 = out_vec[3];
      linear_fit = out_vec[4];
      exp_fit = out_vec[5];

      curr_frame.data[2].x = x;
      curr_frame.data[2].y = linear_fit;
      curr_frame.data[2].name = math.round(String(b1),1) + " + " + math.round(String(b2),3) + "(day)"
      curr_frame.data[1].name = math.round(String(a1),1) + " e^(" + math.round(String(a2),4) + "(day))"
      curr_frame.data[1].x = x;
      curr_frame.data[1].y = exp_fit;
     // console.log(curr_frame)
      frames.push(curr_frame);

  };



  data = []; 
  // build dataset using countries
  for(var i = 0; i < countries.length; i++){
    curr_country = countries[i]; 
    for(var j = 0; j < frames.length; j++){
      //console.log(j, frames[j].name)
        if(frames[j].name==curr_country){
             var trace1 = {
                x: frames[j].data[0].x, 
                y: frames[j].data[0].y,
                mode: 'markers',
                type: 'scatter',
                name: frames[j].name,
            };
            var trace2 = {
                x: frames[j].data[1].x, 
                y: frames[j].data[1].y,
                mode: 'lines',
                type: 'scatter',
                name: frames[j].name + " - " + frames[j].data[1].name
            };
            data.push(trace1);
            data.push(trace2);
          }
        }
  }


  var layout = {
    title: {
      text:'COVID-19 confirmed cases per million',
      font: {
        family: 'Courier New, monospace',
        size: 24
      },
      xref: 'paper',
    },

    xaxis: {
    title: {
      text: 'days since first outbreak',
      font: {
        family: 'Courier New, monospace',
        size: 18,
        color: '#7f7f7f'
      }
    },
  },
  yaxis: {
    title: {
      text: 'cases per million',
      font: {
        family: 'Courier New, monospace',
        size: 18,
        color: '#7f7f7f'
      }
    }
  }
};

   

   Plotly.newPlot(plotDiv, data, layout)

};


// Default with just the Kuwait plot
makeplot(["Kuwait", "Bahrain"]); 


//selector = document.querySelector('.countrydata');
//console.log(selector)


</script>





</body>


<hr>
  

Sourced from <a href="https://ourworldindata.org/coronavirus-source-data"> most recent COVID-19 data</a>. 
<br> </br>
The data for each country is fit to an exponential model, f(x) = a exp(b x),
using <a href = "http://web.stanford.edu/class/ee103/lectures/regression_slides.pdf"> regression</a>. 
<br></br>
Use the drop down menu to select the countries to display. 
<hr>
  Last updated March 28, 9:06 AM CDT.  
<hr>


 <footer>
    Created and maintained by <a href = "https://home.uchicago.edu/~ahmedb/"> Ahmed Bou-Rabee.</a> Please email feedback and suggestions 
    <a href = "mailto: ahmedmb@gmail.com">here</a>. 
  </footer>






